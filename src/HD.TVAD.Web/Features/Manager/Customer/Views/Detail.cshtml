@{
	Layout = null;
}
@model CustomerViewModel
@inject ICustomerViewService _customerViewService
@{
	var customerSelectItems = await _customerViewService.GetCustomerCodeAndNameListItemAsync();

	var customerTypeSelectItems = await _customerViewService.GetCustomerTypeSelectListItemAsync();
}

<form id="detail-form" data-bind="submit: onDetailFormSubmit" asp-area="Manager" asp-controller="Customer" asp-action="EditAPI" method="post" enctype="multipart/form-data" class="form-horizontal">

	<input type="hidden" asp-for="Id" />
	<div class="col-md-3">
		<div class="form-group">
			<div class="col-md-4 control-label">
				<label asp-for="Code"></label>
			</div>
			<div class="col-md-8">
				<input asp-for="Code" class="form-control" type="text" />
				<span asp-validation-for="Code" class="text-danger"></span>
			</div>

		</div>
	</div>
	<div class="col-md-6">
		<div class="form-group">
			<div class="col-md-2 control-label">
				<label asp-for="Name"></label>
			</div>
			<div class="col-md-10">
				<input asp-for="Name" class="form-control" type="text" />
				<span asp-validation-for="Name" class="text-danger"></span>
			</div>

		</div>
	</div>
	<div class="col-md-3">
		<div class="form-group">
			<div class="col-md-4 control-label">
				<label asp-for="TypeId"></label>
			</div>
			<div class="col-md-8">
				<select asp-for="TypeId" class="form-control" type="number">
					<option value="@((int)CustomerTypeEnum.Permanent)">
						@Localizer[CustomerTypeEnum.Permanent.GetDisplayName()]
					</option>
					<option value="@((int)CustomerTypeEnum.NoPermanent)">
						@Localizer[CustomerTypeEnum.NoPermanent.GetDisplayName()]
					</option>
				</select>
				<span asp-validation-for="TypeId" class="text-danger"></span>
			</div>

		</div>
	</div>
	<div class="col-md-3">
		<div class="form-group">
			<div class="col-md-4 control-label">
				<label asp-for="ParentId"></label>
			</div>
			<div class="col-md-8">
				<select asp-for="ParentId" class="form-control" asp-items="customerSelectItems">
					<option value="">@Localizer["None"]</option>
				</select>
				<span asp-validation-for="ParentId" class="text-danger"></span>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="form-group">
			<div class="col-md-4 control-label">
				<label asp-for="Address"></label>
			</div>
			<div class="col-md-8">
				<input asp-for="Address" class="form-control" type="text" />
				<span asp-validation-for="Address" class="text-danger"></span>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="form-group">
			<div class="col-md-4 control-label">
				<label asp-for="PhoneNumber"></label>
			</div>
			<div class="col-md-8">
				<input asp-for="PhoneNumber" class="form-control" type="text" />
				<span asp-validation-for="PhoneNumber" class="text-danger"></span>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="form-group">
			<div class="col-md-4 control-label">
				<label asp-for="FaxNumber"></label>
			</div>
			<div class="col-md-8">
				<input asp-for="FaxNumber" class="form-control" type="text" />
				<span asp-validation-for="FaxNumber" class="text-danger"></span>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="form-group">
			<div class="col-md-4 control-label">
				<label asp-for="TaxNumber"></label>
			</div>
			<div class="col-md-8">
				<input asp-for="TaxNumber" class="form-control" type="text" />
				<span asp-validation-for="TaxNumber" class="text-danger"></span>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="form-group">
			<div class="col-md-4 control-label">
				<label asp-for="RepresentivePerson"></label>
			</div>
			<div class="col-md-8">
				<input asp-for="RepresentivePerson" class="form-control" type="text" />
				<span asp-validation-for="RepresentivePerson" class="text-danger"></span>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="form-group">
			<div class="col-md-4 control-label">
				<label asp-for="PositionOfRepresentivePerson"></label>
			</div>
			<div class="col-md-8">
				<input asp-for="PositionOfRepresentivePerson" class="form-control" type="text" />
				<span asp-validation-for="PositionOfRepresentivePerson" class="text-danger"></span>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		&emsp;
	</div>
	<div class="col-md-6 col-md-offset-4">
		<button type="button" data-bind="click: onCreateBtnClick, attr : {'disabled' : isCreateMode}" class="btn btn-primary-outline" onclick=""><span class="icon icon-plus"></span> @Localizer["Create new"] </button>
		<button type="button" data-bind="click: onSaveBtnClick" class="btn btn-warning-outline" onclick=""><span class="icon icon-action-save"></span> @Localizer["Save"] </button>
		<button type="button" data-bind="click: onDeleteBtnClick, attr : {'disabled' : isCreateMode}" class="btn btn-danger-outline" onclick=""><span class="icon icon-action-delete"></span> @Localizer["Delete"] </button>
		<button type="button" data-bind="click: onCheckBookingCountBtnClick, attr : {'disabled' : isCreateMode}" class="btn btn-success-outline" onclick=""><span class="icon icon-action-edit"></span> @Localizer["Check booking count"] </button>
		
	</div>
</form>



<script>
	require(['module/manager', 'knockout'], function (manager, ko) {
		var localizer = {
			delete: "@Localizer["Delete"]",
			edit: "@Localizer["Edit"]",
			areYouSure: "@Localizer["Are you sure?"]",
			inputNotValid: "@Localizer["Input not valid"]",
		};
		var model = {
			id: '@Model.Id',
			code: "@Model.Code",
			};
		var form = $("#detail-form");

		var viewModel = {
			code: ko.observable(model.code),
			onCodeKeyUp: function (d, e) {
				console.log("onCodeKeyUp");
				var _this = this;
				if (e.keyCode == 13) {
					_this.network.findByCode(_this.code());
					return false; // ignore default event
				}
				return false;
			},
			isCreateMode: ko.observable(false),
			onCreateBtnClick: function () {
				console.log("onCreateBtnClick");
				var _this = this;
				_this.isCreateMode(true);
				$("#detail-panel-body").animate({ opacity: 0.1 }, 0).animate({ opacity: 1 }, 200);
				form.find("#Code").focus();
				form.find("input[type=text], textarea").val("");
			//	_this.network.createCustomer();
			},
			onSaveBtnClick: function () {
				console.log("onSaveBtnClick");
				var _this = this;
				if (_this.isCreateMode())
					_this.network.createCustomer();
				else
				{
					if (confirm(localizer.edit))
						form.submit();
				}
			},
			onDeleteBtnClick: function () {
				console.log("onDeleteBtnClick");
				var _this = this;
				if (confirm(localizer.delete)) {
					_this.network.deleteCustomer();
				}
				else {

				 }

			},
			onCheckBookingCountBtnClick: function () {
				console.log("onCheckBookingCountBtnClick");
				$.ajax({
					url: "Manager/Customer/CheckSpotBookingCount/@Model.Id",
					success: function (response) {
						alert(response);
					}
				});
			},
			onDetailFormSubmit: function (d, e) {
				var _this = this;
				console.log("onDetailFormSubmit");
				_this.network.editCustomer();
			},
			network: {
				editCustomer: function () {
					console.log(form.serialize());
					if (form.valid()) {
						$.ajax({
							url: form.attr('action'),
							method: form.attr('method'),
							data: form.serialize(),
							success: function (response) {
								console.log(response);
								if (typeof response == 'object') {
									if (response.Succeeded) {
										notification.show(response.Message);

										refreshTree(response.Id);
									}
									else {
										alert(response.Message);
									}
								}
								else {
									alert(response);
								}
							},
							error: function () {

							}
						});

					}
					else
						alert(localizer.inputNotValid);
				},
				createCustomer: function () {
					var createUrl = "Manager/Customer/CreateAPI";
					if (form.valid()) {
						$.ajax({
							url: createUrl,
							method: form.attr('method'),
							data: form.serialize(),
							success: function (response) {
								console.log(response);
								if (typeof response == 'object') {
									if (response.Succeeded) {
										notification.show(response.Message);
										var urlPath = '/Manager/Customer/Detail/' + response.Id
										$('#detail-panel-body').load(urlPath);
											refreshTree(response.Id);

									}
									else {
										alert(response.Message);
									}
								}
								else {
									alert(response);
								}
							},
							error: function () {

							}
						});
					}
					else
						alert(localizer.inputNotValid);
				},
				deleteCustomer: function () {
					var deleteUrl = "Manager/Customer/DeleteAPI";
					console.log(form.serialize());
					$.ajax({
						url: deleteUrl,
						method: form.attr('method'),
						data: form.serialize(),
						success: function (response) {
							console.log(response);
							if (typeof response == 'object') {
								if (response.Succeeded) {
									notification.show(response.Message);
									refreshTree("");
								}
								else {
									alert(response.Message);
								}
							}
							else {
								alert(response);
							}
						},
						error: function () {

						}
					});
				},
				findByCode: function (code) {
					var url = "Manager/AnnexContract/FindByCodeAPI";
					$.ajax({
						url: url,
						method: 'GET',
						data: {
							code: code,
							bookingType: model.bookingType
						},
						success: function (response) {
							console.log(response);
							if (typeof response == 'object') {
								if (response.Succeeded) {
									notification.show(response.Message);
									var urlPath = '/AnnexContract/NormalBooking/Detail/' + response.Id
									$('#detail-panel-body').load(urlPath);
								}
								else {
									alert(response.Message);
								}
							}
							else {
								alert(response);
							}
						},
						error: function () {

						}
					});
				}
			}
		};
		ko.applyBindings(viewModel, $("#detail-form")[0]);

		function refreshTree(id) {
			var tree = $("#tree-list").data("kendoTreeList");
			tree.options.settings.dataItemId = id;
			if (tree)
				tree.dataSource.read();

		//	tree.options.settings.dataItemId = '';
		}

	});
</script>



