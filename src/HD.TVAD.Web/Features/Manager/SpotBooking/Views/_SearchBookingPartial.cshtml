@model SpotBookingSearchIndexViewModel
@inject ITimeBandViewService _timeBandViewService
@{
	var timeBandSelectItems = await _timeBandViewService.GetSelectListItemAsync();
}
<form class="form-horizontal">
	<div class="form-group">
		<div class="col-md-4 control-label">
			<label asp-for="FromDate"></label>
		</div>
		<div class="col-md-8">
			<input asp-for="FromDate" class="form-control" data-bind="value: fromDate, event: {change: onFromDateChange}" type="date" />
		</div>
	</div>
	<div class="form-group">
		<div class="col-md-4 control-label">
			<label asp-for="ToDate"></label>
		</div>
		<div class="col-md-8">
			<input asp-for="ToDate" data-bind="value: toDate, event: {change: onToDateChange}" class="form-control" type="date" />
		</div>
	</div>
	<div class="form-group">
		<div class="col-md-4 control-label">
			<label asp-for="TimeBandId"></label>
		</div>
		<div class="col-md-8">
			<select asp-for="TimeBandId" class="form-control" data-bind="value: timeBandId, event: {change: onTimeBandSelectChange}" asp-items="timeBandSelectItems">
				<option value="">@Localizer["Choose..."]</option>
			</select>
		</div>
	</div>
	<div class="form-group">
		<div class="col-md-4 control-label">
			<label asp-for="TimeBandSliceId"></label>
		</div>
		<div class="col-md-8">
			<select class="form-control" asp-for="TimeBandSliceId" data-bind="enable: enableTimeBandSliceSelect,
					value: timeBandSliceId, 
					event: {change: onTimeBandSliceSelectChange},
					options: timebandSliceOptions,
								optionsText: 'name',
								optionsValue: 'id',
								optionsCaption: '@Localizer["Choose..."]'"></select>
		</div>
	</div>
	<hr />
	<div class="form-group">
		<div class="col-md-12 text-center">
			<button id="btn-search" type="button" data-bind="click: onSearchBtnClick" class="btn btn-primary-outline"> <span class="icon icon-search"></span> @Localizer["Search"] </button>
			<button id="btn-clear" type="button" data-bind="click: onClearBtnClick" class="btn btn-default-outline"> <span class="icon icon-action-delete"></span> @Localizer["Reset"] </button>
		</div>
	</div>
</form>

<script>
	require(["jquery", "knockout"], function ($, ko) {

		var timebandSliceOption = function (id, name) {
			this.name = name;
			this.id = id;
		};
		var searchSpotViewModel = {
			fromDate: ko.observable($("#FromDate").val()),
			toDate: ko.observable($("#ToDate").val()),
			timeBandId: ko.observable(),
			timeBandSliceId: ko.observable(),
			enableTimeBandSliceSelect: ko.observable(false),
			onFromDateChange: function () {
				this.searchSpot();
			},
			onToDateChange: function () {
				this.searchSpot();
			},
			onSearchBtnClick: function () {
				this.searchSpot();
			},
			onTimeBandSliceSelectChange: function () {
				this.searchSpot();
			},
			searchSpot: function () {
				var _this = this;
				var grid = $("#grid-spotBooking").data("kendoGrid");
				var dataSource = grid.dataSource;
				dataSource.read({
					fromDate: _this.fromDate(),
					todate: _this.toDate(),
					timeBandId: _this.timeBandId(),
					timeBandSliceId: _this.timeBandSliceId()
				});

			},
			onClearBtnClick: function () {
				var _this = this;
				_this.fromDate("");
				_this.toDate("");
				_this.timeBandId("");
				_this.timeBandSliceId("");
				_this.enableTimeBandSliceSelect(false);
				_this.timebandSliceOptions([]);
			},
			timebandSliceOptions: ko.observableArray(),
			onTimeBandSelectChange: function (data, event) {
				var _this = this;
				this.searchSpot();
				if (_this.timeBandId()) {
					_this.enableTimeBandSliceSelect(true);
					_this.timebandSliceOptions([]);
					$.ajax({
						url: "Manager/TimeBand/GetAllTimeBandSliceByTimeBandId",
						type: 'GET',
						data: { TimeBandId: _this.timeBandId() },
						success: function (response) {
							console.log(response);
							var data = response.Data;
							$.each(data, function (i, v) {
								_this.timebandSliceOptions.push(
									new timebandSliceOption(v.Id, v.Name));
							});
						}
					});
				}
				else {
					_this.enableTimeBandSliceSelect(false);
					_this.timebandSliceOptions([]);
				}
			}
		};

		ko.applyBindings(searchSpotViewModel, $("#search-panel")[0]);

	});
</script>